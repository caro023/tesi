\chapter{Studio e sperimentazione della gestione di policy in Teraflow}
\label{cap:policy}
Lo scopo della tesi è quello di stabilire una connessione tra due end points nella rete che rispetti determinate caratteristiche utilizzando il controller SDN Teraflow.
Inizialmente, attraverso il Service Level, è stato introdotto un servizio nella rete sotto forma di intento per stabilire la connessione e il percorso. 
Successivamente, tramite il Management Level, è stata inserita una politica basata sugli eventi. Questa politica permette agli operatori 
di associare a un servizio scelto un service level agreement (SLA) con specifiche condizioni che devono essere rispettate a run time.
%end-to-end
%tutte queste info sono persistite in un database logicamente centralizzato, fisicamente distribuito e scalabile, dato dalla componente di Context
\\Per iniziare il lavoro si è partiti da una demo già esitente per poi apportare delle modifiche successivamente.
\\\textbf{Servizio end-to-end}
\\Come già detto in precedenza il Device Level sfrutta una South-Bound Interface (SBI) per interagire con i device tramite l'API P4Runtime. 
Inizialmente, il codice p4 compilato, ossia i vari artefatti, viene copiato nel pod SBI per poter inserire le giuste configurazioni nelle tabelle dei dispositivi.
Il passo successivo è registrare i dispositivi e i link al controller SDN per permettere una corretta comunicazione tra di essi.
A questo punto, siamo in grado di richiedere una connessione tra due end points specificando solamente i dispositivi finali tramite un servizio.
La componente di Service, ricevuta la richiesta, si rivolge alla PathComp per calcolare un percorso.
Per eseguire questa operazione la PathComp utilizza delle informazioni della rete che persistono nel database logicamente centralizzato della componente di Context.
\\Una volta ricevuto il percorso, la componente di Service configura i dispositivi lungo il percorso tramite l'SBI.
Per mantenere questo processo agnostico rispetto ai dettagli della tecnologia, la componente di Service 
sfrutta una definizione minima permettendo agli utenti di esprimete cosa vogliono connettere, lasciando che sia il sistema sottostante a decidere come realizzare la connessione reale.
La componente traduce automaticamente questa definizione minimale del servizio in modelli di configurazioni astratte dei dispositivi. 
Queste vengono a loro volta tradotte in regole P4 dal driver del dispositivo P4 della SBI.
\\\textbf{Vincoli e configurazioni di servizio}
\\È possibile richiedere azioni supplementari, come l'aggiunta di vincoli o configurazioni di servizio specifiche. 
%In questo modo il componente Policy offre SLA basati sugli eventi per servizi di connettività end-to-end tramite pipeline P4
Queste vengono specificate inizialmente alla creazione di un servizio e devono essere rispettate finchè quest'ultimo non verrà eliminato. 
Ciò semplifica la gestione dei servizi, in quanto la dichiarazione di queste informazioni aggiuntive può sostituire l'associazione di una politica.
\\Nella demo presa in considerazione i vincoli non erano specificati ma sono stati aggiunti per quanto riguarda la latenza e la capacità del percorso.
Questa aggiunta non ha prodotto cambiamenti nella definizione del percorso poiché le funzioni relative all'effettivo funzionamento di queste funzionalità non 
sono ancora state implementate nel controller ma sono solo pianificate per release future.
Altri esempi di vincoli possono essere rappresentati dalla posizione di un dispositivo, che può essere sia terminale che non, dal tempo o dal numero di passi massimo di un determinato percorso.
\begin{figure}[h]
    \centering
   \includegraphics[width=1\textwidth]{servizion constraints.png}
    \caption{Servizio creato in fase di sperimentazione}
    \label{fig:constraints}
\end{figure}
%spiegare cosa sono i constraits, guarda i deliverable
%dire che non sono implementati
%run-time-->loss+latenza
\\\textbf{Politica}
\\Una parte fondamentale nei sistemi moderni è la gestione a run-time del servizio stabilito.
A tale scopo, si sfrutta la componente di Monitoring, che permette di associare il monitoraggio delle metriche nel proprio database,
con condizioni che devono essere rispettate.
Quando queste condizioni non vengono soddisfatte, la componente di Monitoring solleva un allarme che fa scattare l'azione prestabilita.
\\Nella sperimentazione abbiamo introdotto una politica per il servizio stabilito con due condizioni: una per la latenza (che non deve superare i 100ms) e una per la loss (che non deve superare il 20\%).
Queste due condizioni sono legate tra loro tramite un "OR", quindi appena una delle due non è più rispettata, viene invocata l'azione.
In questo caso l'azione consiste nel ricalcolo del percorso.
%MODIFICA O LA FOTO O LA DESCRIZIONE
\begin{figure}[h]
    \centering
   \includegraphics[width=1\textwidth]{policy loss,latency.png}
    \caption{Politica creata in fase di sperimentazione}
    \label{fig:policy}
\end{figure}
\\\textbf{Verifica}
\\Per verificare il comportamento del controller e assicurarsi che le condizioni di latenza e di loss vengano rispettate, 
non avendo a disposizione una rete reale, abbiamo utilizzato una topologia di rete su Mininet di switch P4 basati su bmv2.
La topologia iniziale era composta da 4 switch ed è stata poi ampliata a 8 per renderla più complessa con l'aggiunta di più percorsi possibili tra i due end-points.
I dispositivi della topologia sono stati connessi alla componente SBI, come per i dispositivi reali, in modo tale che potessero comunicare con il controller.
Successivamente per dimostrare la politica basata sul servizio e il ricalcolo del percorso, abbiamo aggiunto artificialmente delle condizioni di ritardo e packet loss all’interno di uno switch presente nel percorso. 
Ad esempio, abbiamo utilizzato il comando \textit{switch2 tc qdisc add dev switch2-eth2 root netem delay 200ms} per aggiungere un ritardo di 200ms oppure il comando \textit{switch2 tc qdisc add dev switch2-eth2 root netem loss 50\%}
 per simulare una perdita di pacchetti del 50\%. Inoltre, abbiamo disattivato un link tra due switch con il comando \textit{link switch6 switch7 down}.
\\Questi cambiamenti sono stati monitorati grazie a un probe in Python, una funzionalità che rileva lo stato di integrità delle istanze dell'applicazione.
Il probe cattura le metriche di loss e latenza per poi inviarle alla componente di Monitoring.
\\La componente, ricevute le metriche, riconosce che è avvenuto un cambiamento nella rete e solleva un allarme per una potenziale violazione della politica che sarà poi validata dalla componente di policy.
Questo evento causa l'esecuzione dell'azione predefinita nella politica, ovvero l'aggiornamento del percorso.
Quando il nuovo percorso è calcolato dalla Path Comp, la componente di Service compila una lista di configurazioni di dispositivi per stabilire un nuovo percorso
seguita da un'altra lista di comandi per la cancellazione del vecchio. Questi comandi sono tradotti in regole P4 dalla componente SBI prima di essere imposti al piano dati 
tramite il P4Runtime.
\\In tutte e tre le tipologie di alterazione della rete, si è riscontrato un cambiamento del percorso per rispettare le condizioni desiderate. 
%Inoltre, si è notato che una volta rimosso il ritardo, la perdita di pacchetti, o riattivato un link, il controller percepisce questo cambiamento e modifica automaticamente il percorso precedente, poiché è memorizzato nel database della Path Comp come percorso preferito per le sue caratteristiche.

